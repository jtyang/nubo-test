##1.MainActivity
1.1）初始化KurentoRoomAPI，根据wss地址，建立websocket连接
注意点：是否需要cr证书？
代码：
onCreate
kurentoRoomAPI = new KurentoRoomAPI(executor, wsUri, this);

onStart
if (!kurentoRoomAPI.isWebSocketConnected()) {
    kurentoRoomAPI.connectWebSocket();
}

连接成功，回调onRoomConnected()

1.2）加入房间--websocket
在onRoomConnected()函数执行
if (kurentoRoomAPI.isWebSocketConnected()) {
            joinRoom();
}

private void joinRoom() {
        Constants.id++;
        roomId = Constants.id;
        Log.i(TAG, "Joinroom: User: " + this.username + ", Room: " + this.roomname + " id:" + roomId);
        if (kurentoRoomAPI.isWebSocketConnected()) {
            kurentoRoomAPI.sendJoinRoom(this.username, this.roomname, true, roomId);
        }
}
注意，这里的房间号是随便搞的。。。

##2.发起呼叫PeerVideoActivity
2.1）PeerVideoActivity--onCreate
添加RoomListener到MainActivity的kurentoRoomAPI

2.2）PeerVideoActivity--onStart
创建NBMWebRTCPeer，并调用NBMWebRTCPeer的initialize()
private NBMWebRTCPeer nbmWebRTCPeer;
nbmWebRTCPeer = new NBMWebRTCPeer(peerConnectionParameters, this, localView, this);

2.3)PeerVideoActivity--onResume
protected void onResume() {
        super.onResume();
        nbmWebRTCPeer.startLocalMedia();
    }

public boolean startLocalMedia() {
        if (mediaResourceManager != null && mediaResourceManager.getLocalMediaStream() == null) {
            executor.execute(new Runnable() {
                @Override
                public void run() {
                    startLocalMediaSync();
                }
            });
            return true;
        } else {
            return false;
        }
    }
private boolean startLocalMediaSync() {
        if (mediaResourceManager != null && mediaResourceManager.getLocalMediaStream() == null) {
            mediaResourceManager.createLocalMediaStream(VideoRendererGui.getEglBaseContext(), localRender);
            mediaResourceManager.startVideoSource();
            mediaResourceManager.selectCameraPosition(config.getCameraPosition());
            return true;
        } else {
            return false;
        }
    }

2.4）NBMWebRTCPeer
public void initialize() {
        executor.execute(new Runnable() {
            @Override
            public void run() {
                signalingParameters = new SignalingParameters(iceServers, true, "", null, null);
                createPeerConnectionFactoryInternal(context);
                peerConnectionResourceManager = new PeerConnectionResourceManager(peerConnectionParameters, executor, peerConnectionFactory);
                mediaResourceManager = new MediaResourceManager(peerConnectionParameters, executor, peerConnectionFactory);
                initialized = true;
                observer.onInitialize();
            }
        });
    }
private void createPeerConnectionFactoryInternal(Context context) {
    //省略部分代码。。。
    PeerConnectionFactory.initializeFieldTrials(field_trials);
    if (!PeerConnectionFactory.initializeAndroidGlobals(context, true, true, peerConnectionParameters.videoCodecHwAcceleration)) {
                observer.onPeerConnectionError("Failed to initializeAndroidGlobals");
    }
    peerConnectionFactory = new PeerConnectionFactory();
}

可以看到这里主要创建了SignalingParameters、PeerConnectionFactory和MediaResourceManager

2.4）PeerVideoActivity--onInitialize
public void onInitialize() {
        nbmWebRTCPeer.generateOffer("local", true);
    }

2.5）NBMWebRTCPeer.java
public void generateOffer(String connectionId, boolean includeLocalMedia){
        executor.execute(new GenerateOfferTask(connectionId, includeLocalMedia));
    }
private class GenerateOfferTask implements Runnable {

        String connectionId;
        boolean includeLocalMedia;

        private GenerateOfferTask(String connectionId, boolean includeLocalMedia){
            this.connectionId = connectionId;
            this.includeLocalMedia = includeLocalMedia;
        }

        public void run() {
            if (mediaResourceManager.getLocalMediaStream() == null) {
                mediaResourceManager.createMediaConstraints();
                startLocalMediaSync();
            }

            NBMPeerConnection connection = peerConnectionResourceManager.getConnection(connectionId);

            if (connection == null) {
                if (signalingParameters != null) {

                    connection = peerConnectionResourceManager.createPeerConnection(
                                                                signalingParameters,
                                                                mediaResourceManager.getPcConstraints(),
                                                                connectionId);
                    connection.addObserver(observer);
                    connection.addObserver(mediaResourceManager);
                    if (includeLocalMedia) {
                        connection.getPc().addStream(mediaResourceManager.getLocalMediaStream());
                    }

                    DataChannel.Init init =  new DataChannel.Init();
                    createDataChannel(this.connectionId, "default", init);

                    // Create offer. Offer SDP will be sent to answering client in
                    // PeerConnectionEvents.onLocalDescription event.
                    connection.createOffer(mediaResourceManager.getSdpMediaConstraints());
                }
            }
        }
    }

















































